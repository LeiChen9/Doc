# 医学问答系统知识库技术方案文档（实验阶段：基于单个EPUB文件）

## 概述
本技术方案文档针对医学问答系统的知识库部分，提供详细、可执行指导，聚焦于实验阶段的场景：本地`data`目录下只有一个EPUB文件（`merck_guide.epub`）。本文档强调概念、流程和生产方式的阐述，实现细节由开发者自行判断。

实验目标：从单个EPUB文件构建结构化知识库，确保每条记录基于事实、可溯源。知识库规模小型（数百到数千条记录），适用于验证检索准确性和溯源完整性。核心概念包括：
- **知识单元**：EPUB文件被拆解为最小逻辑块（如句子或段落），每个单元对应数据库一条记录，包含主题实体、原文摘要等。
- **实体（Entity）**：数据库表中的核心字段，指医学领域的关键概念（如“冠心病”、“阿司匹林”），将文本内容交由大模型进行实体抽取（需要设计 prompt 与大模型api交互）
- **溯源链**：每条记录保留EPUB文件的元数据（如章节路径、页码），允许用户追溯到原文件位置。
- **向量表示**：为每个知识单元生成语义向量，用于后续相似度检索。

数据库采用PostgreSQL + pgvector，确保事务性和向量检索效率。整个构建过程是离线的、批量的，便于开发者在本地环境迭代。

## 1. 数据库设计与概念
数据库设计以结构化为导向，表结构支持EPUB文件的层次化内容（EPUB本质上是ZIP压缩的HTML/XML文件集合，包括目录、章节和元数据）。概念上，数据库将EPUB视为“树状知识结构”：根节点为文件整体，分支为章节，叶节点为具体知识单元。

### 1.1 核心表设计
- **主表：knowledge_records**（存储知识单元）
  - **id**：唯一标识符（UUID类型），自动生成，用于记录唯一性。
  - **entity**：主题实体（字符串，长度限制200字符）。概念：这是知识单元的“锚点”，代表核心医学概念（如疾病、症状、药物）。实体来源于大模型针对文本的实体抽取，例如从句子“冠心病患者应避免高脂饮食”中识别“冠心病”作为实体。实体不是随意字符串，而是标准化后的术语（引用UMLS或自定义医学术语典），避免同义词歧义（如“高血压”统一为“hypertension”）。如果文本无明显实体，可默认用章节标题填充。（大模型抽取 + 逻辑兜底判断）
  - **title**：知识点标题（字符串）。概念：直接从EPUB的章节标题或子标题继承，用于快速定位。例如，从EPUB的TOC（目录）中提取“第10章：心血管疾病”。
  - **text**：原文片段（文本类型，长度可达数千字符）。概念：EPUB提取的原始文本块。
  - **source**：来源出处（字符串）。概念：固定为EPUB文件名（如“medical_guideline.epub”），加上发布元数据（如作者、年份，从EPUB的metadata XML提取）。
  - **chapter_path**：章节路径（字符串）。概念：层次化路径，如“内科学 > 第10章 > 冠心病 > 病理机制”，从EPUB的TOC和spine（章节顺序）构建，便于溯源和过滤查询。
  - **tags**：标签数组（数组或JSON类型）。概念：描述性关键词，如["疾病", "机制", "内科"]，从文本关键词提取或章节主题推导，用于关键词索引。
  - **metadata**：元数据（JSON类型）。概念：扩展信息，如{"evidence_level": "高", "publish_date": "2023", "page_range": "150-155", "discipline": "内科"}。从EPUB的Dublin Core metadata和提取位置生成，支持证据等级评估（基于源权威性）。
  - **vector**：嵌入向量（pgvector类型，维度如384，取决于模型如BGE-small-zh）。概念：文本的语义表示，用于相似度检索。从text或summary生成，确保向量捕捉医学语义。

### 1.2 设计原则
- **规范化**：实体和标签标准化，减少冗余（例如，使用数据库约束或后处理确保实体唯一）。
- **可扩展性**：JSON字段允许未来添加如“证据链接”而不改表结构。
- **性能考虑**：为entity、source、chapter_path创建B-tree索引；vector使用HNSW索引加速相似度查询。
- **一致性**：所有字段必填（除vector外），通过数据库默认值或构建流程强制。
- **规模估算**：单个EPUB（假设200页）可生成数百记录，每记录平均1KB，数据库占用小。

## 2. 从EPUB文件构建数据库的整体流程设计
构建流程分为获取、整理、提取/生成、落库和索引五个阶段，采用批处理模式（一次性处理整个文件）。开发者可设计为脚本驱动的管道（pipeline），每个阶段输出中间结果（如JSON文件）供调试。流程强调数据流动：从原始EPUB字节流，到结构化记录，再到数据库持久化。

### 2.1 阶段1：数据获取
- **概念**：获取是将本地EPUB文件加载为可处理的结构。EPUB文件是一个ZIP包，内部包含opf文件（元数据和spine）、ncx文件（目录TOC）和HTML/XHTML章节文件。
- **生产方式**：
  1. 扫描`data`目录，定位单个EPUB文件（路径如`data/merck_guide.epub`）。
  2. 提取文件级元数据：解析content.opf或Dublin Core，获取书名、作者、发布日期，作为全局metadata基础。
  3. 输出：一个内存结构或临时文件，包含文件哈希、元数据和章节列表（从spine和TOC获取）。
- **开发者指导**：使用EPUB解析库遍历ZIP内容，避免手动解压。处理异常如损坏文件，通过日志记录。

### 2.2 阶段2：数据整理（解析与切分）
- **概念**：整理是将EPUB的非结构化内容（HTML章节）转换为逻辑块。EPUB的结构天然分层：章节 > 段落 > 句子/表格。
- **生产方式**：
  1. 解析EPUB结构：加载spine顺序，逐章节读取HTML内容，剥离标签保留纯文本（保留<strong>等强调作为标签线索）。
  2. 章节级切分：基于TOC构建chapter_path（如“卷1 > 章2 > 节3”），每个章节作为一个大块。
  3. 细粒度切分：将章节文本按“标题-小节-表格”策略拆分。
     - 标题：从<h1>、<h2>等标签识别。
     - 小节：按段落或固定长度（e.g., 200-500字）切分，确保逻辑完整。
     - 表格/图表：识别<table>标签，转换为结构化描述（e.g., “表格：药物剂量，列：药物名、剂量”）；图表描述从alt文本或周边文本推导。
  4. 清洗：移除页眉/页脚、噪声（如版权声明），保留页码锚点（从HTML id或估算）。
  5. 输出：列表 of 文本块，每个块附带chapter_path、页码范围和初步metadata。
- **开发者指导**：优先处理中文EPUB，确保UTF-8编码。切分时可以使用大模型进行切分，保证内容逻辑完整，边界清晰。

### 2.3 阶段3：实体提取与记录生成
- **概念**：这一阶段生成数据库记录的核心内容，特别是entity。实体是知识单元的“身份”，通过大模型总结（精细设计 prompt）
- **生产方式**：
  1. NLP预处理：对每个文本块应用大模型，识别医学实体。
     - 示例：文本“冠心病常表现为胸痛” → 提取entity="冠心病"，tags=["疾病", "症状"]。
     - 如果多实体，取主实体（e.g., 句子主题）；无实体时，用章节标题填充或跳过。
  2. 向量化：将text或summary输入嵌入模型，生成vector（维度固定，如384维），捕捉语义相似（如“心绞痛”与“冠心病”相关）。
  3. 记录组装：为每个文本块创建一个记录对象，填充所有字段（entity从NER来，metadata继承文件/章节信息）。
  4. 质量过滤：丢弃短块（<50字）或非医学内容，人工审核点位（开发者可插入检查步骤）。
- **开发者指导**：大模型实体抽取部分的 prompt 要精心设计，确保标准化与严谨性；向量生成批量处理以节省计算。确保实体归一化（e.g., 映射到标准词典）。

### 2.4 阶段4：落库（持久化）
- **概念**：落库是将生成的记录列表批量写入数据库，确保原子性和一致性。
- **生产方式**：
  1. 连接数据库，检查表存在（若无，创建）。
  2. 批量插入：分组记录（e.g., 每100条），使用事务包裹；对于vector，使用pgvector语法存储。
  3. 冲突处理：如果id或entity重复，更新而非插入（使用UPSERT）。
  4. 日志记录：插入后，更新update_logs表，记录批次详情。
  5. 验证：查询插入行数，检查随机记录完整性。
- **开发者指导**：使用ORM简化SQL；处理大向量时监控内存。

### 2.5 阶段5：索引建立
- **概念**：索引使数据库可检索，关键词索引用于精确匹配，向量索引用于语义搜索。
- **生产方式**：
  1. 关键词索引：对entity、tags、text创建全文索引（PostgreSQL tsvector）。
  2. 向量索引：对vector列建HNSW索引（参数如m=16，ef_construction=64）。
  3. 复合索引：为chapter_path + entity建联合索引。
  4. 构建触发：落库后自动运行，或手动 vacuum/analyze 优化。
- **开发者指导**：测试查询延迟，调整索引参数基于记录规模。

## 3. 实验验证与迭代
- **验证流程**：构建后，模拟查询（如“冠心病机制”），检查返回记录的entity和溯源。
- **潜在问题**：EPUB布局复杂（e.g., 嵌套表格），开发者需迭代切分策略；实体提取准确率依赖模型，建议集成反馈循环。
- **扩展**：未来添加更多文件时，重复流程并合并source。